#!/bin/sh

echo "Running pre-commit hook..."

# Navigate to frontend directory from repo root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT/frontend" || exit 1


# Run prettier check
echo "Checking code formatting with Prettier..."
if ! bun run format:check; then
    echo ""
    echo "Error: Code formatting issues found! Please run 'bun run format' to fix formatting issues."
    echo "Run 'cd frontend && bun run format:check' to see the formatting issues."
    exit 1
fi

# Run the build command
echo "Running bun build..."
if ! bun run build; then
    echo ""
    echo "Error: Build failed! Please fix the build errors before committing."
    echo "Run 'cd frontend && bun run build' to see the errors."
    exit 1
fi

# Run unit tests
echo "Running bun test..."
if ! bun run test; then
    echo ""
    echo "Error: Unit tests failed! Please fix failing tests before committing."
    echo "Run 'cd frontend && bun run test' to see the failures."
    exit 1
fi

# Run Rust unit tests only when relevant Rust/Tauri files are staged
STAGED_FILES=$(git diff --cached --name-only)
if echo "$STAGED_FILES" | grep -Eq '^frontend/src-tauri/.*\.(rs|toml|lock)$'; then
    echo "Running Rust unit tests..."
    cd "$REPO_ROOT/frontend/src-tauri" || exit 1
    if ! cargo test --all-targets; then
        echo ""
        echo "Error: Rust tests failed! Please fix the test failures before committing."
        echo "Run 'cd frontend/src-tauri && cargo test --all-targets' to see the errors."
        exit 1
    fi
else
    echo "No staged Rust changes detected; skipping Rust unit tests."
fi

echo "All checks passed! Proceeding with commit..."
exit 0
